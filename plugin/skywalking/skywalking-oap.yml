###################################################################################################################
##
## skywalking安装，注意替换以下变量：
## ${SW_ES_USER}: es7用户名
## ${SW_ES_PASSWORD}: es7密码
## ${SW_STORAGE_ES_CLUSTER_NODES}: es7域名
## ${SW_STORAGE_ES_HTTP_PROTOCOL}: es7使用协议（http或者https）
##
## 如果使用MySQL，请替换以下变量
## ${MYSQL_PASSWORD}: mysql root用户密码；
## ${MYSQL_STORAGE}: mysql存储大小，例如100Gi
## ${MYSQL_IMAGE}: mysql的镜像，需要是5.7镜像的，例如nexus.niceloo.com:8083/youlu/mysql:5.7
## ${MYSQL_MEMORY}: mysql实例的内存；例如5Gi，建议4G以上，如果是4G以下请调整mysql参数；
## ${MYSQL_REQUEST_CPU}: mysql实例的最小cpu；例如3000m；
## ${MYSQL_LIMIT_CPU}: mysql实例的最大cpu；例如8000m；
## 
###################################################################################################################


---
apiVersion: v1
kind: Namespace
metadata:
  name: middleware
---


---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: skywalking-oap
  name: skywalking-oap-svc-account
  namespace: middleware

---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: skywalking-oap-role
  namespace: middleware
  labels:
    app: skywalking-oap
rules:
  - apiGroups: [""]
    resources: ["pods","configmaps"]
    verbs: ["get", "watch", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: skywalking-oap-role-binding
  namespace: middleware
  labels:
    app: skywalking-oap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: skywalking-oap-role
subjects:
  - kind: ServiceAccount
    name: skywalking-oap-svc-account
    namespace: middleware


---

apiVersion: v1
kind: ConfigMap
metadata:
  name: skywalking-oap-configmap
  namespace: middleware
  labels:
    app: skywalking-oap
data:

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: skywalking-oap
  name: skywalking-oap
  namespace: middleware
spec:
  replicas: 2
  selector:
    matchLabels:
      app: skywalking-oap
  template:
    metadata:
      labels:
        app: skywalking-oap
    spec:
      serviceAccountName: skywalking-oap-svc-account
      # 一台主机上不允许安装两个副本
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: "kubernetes.io/hostname"
              labelSelector:
                matchLabels:
                  app: "skywalking-oap"
      containers:
      - name: skywalking-oap
        # 注意，如果要使用MySQL作为存储，那么需要自己添加MySQL的驱动
        image: apache/skywalking-oap-server:8.6.0-es7
        imagePullPolicy: Always
        livenessProbe:
          tcpSocket:
            port: 12800
          failureThreshold: 15
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          tcpSocket:
            port: 12800
          initialDelaySeconds: 15
          periodSeconds: 20
        ports:
        - containerPort: 11800
          name: grpc
        - containerPort: 12800
          name: rest
        volumeMounts:
          # 将application.yml挂载到/skywalking/config/application.yml，注意，这里要使用subPath，不然会将/skywalking/config目录全部覆盖
          - mountPath: /skywalking/config/application.yml
            subPath: application.yml
            name: application.yml
        env:
        - name: JAVA_OPTS
          value: "-Xms2g -Xmx2g"
        # 指定当前使用K8S做集群管理（服务发现）
        - name: SW_CLUSTER
          value: kubernetes
        - name: SW_CLUSTER_K8S_NAMESPACE
          value: middleware
        - name: SW_CLUSTER_K8S_LABEL
          value: app=skywalking-oap
        # 使用K8S的config-map做动态配置
        - name: SW_CONFIGURATION
          value: k8s-configmap
        # 配置刷新时间，单位秒
        - name: SW_CONFIG_CONFIGMAP_PERIOD
          value: "60"
        - name: SKYWALKING_COLLECTOR_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        # 后端配置参考文档：https://skywalking.apache.org/docs/main/v8.5.0/en/setup/backend/backend-setup/
        # storage配置，环境变量名可以参考文档：https://skywalking.apache.org/docs/main/v8.5.0/en/setup/backend/backend-storage/
        # 这里使用es7作为后端存储，这块儿比MySQL好使，es安装参考es的安装
        - name: SW_STORAGE
          value: elasticsearch7
        - name: SW_ES_USER
          value: ${SW_ES_USER}
        - name: SW_ES_PASSWORD
          value: ${SW_ES_PASSWORD}
        - name: SW_STORAGE_ES_CLUSTER_NODES
          value: ${SW_STORAGE_ES_CLUSTER_NODES}
        - name: SW_STORAGE_ES_HTTP_PROTOCOL
          value: ${SW_STORAGE_ES_HTTP_PROTOCOL}
        # 使用MySQL时使用以下
        #- name: SW_STORAGE
        #  value: mysql
        ## jdbc url
        #- name: SW_JDBC_URL
        #  value: jdbc:mysql://mysql-skywalking:3306/skywalking
        ## 用户名
        #- name: SW_DATA_SOURCE_USER
        #  value: root
        ## 密码
        #- name: SW_DATA_SOURCE_PASSWORD
        #  value: "${MYSQL_PASSWORD}"
        ## 开启prep STMTS缓存
        #- name: SW_DATA_SOURCE_CACHE_PREP_STMTS
        #  value: "true"
        ## 预编译sql缓存条数
        #- name: SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT
        #  value: "2048"
        ## 使用预编译sql
        #- name: SW_DATA_SOURCE_USE_SERVER_PREP_STMTS
        #  value: "true"
        # 资源限制，注意，1Gi=1024Mi=1024*1024Ki = 1024*1024*1024Bi=1024*1024*1024byte，1G=1000M=1000*1000K=1000*1000*1000byte
        resources:
          limits:
            cpu: 6000m
            memory: 3Gi
          requests:
            cpu: 1000m
            memory: 3Gi
      tolerations:
      - effect: NoExecute
        key: node.kubernetes.io/unreachable
        operator: Exists
        tolerationSeconds: 5
      - effect: NoExecute
        key: node.kubernetes.io/not-ready
        operator: Exists
        tolerationSeconds: 5
      - effect: NoExecute
        key: node.kubernetes.io/unschedulable
        operator: Exists
        tolerationSeconds: 5
      - effect: NoExecute
        key: node.kubernetes.io/network-unavailable
        operator: Exists
        tolerationSeconds: 5
      volumes:
        - name: application.yml
          configMap:
            name: skywalking-oap
            items:
              - key: application.yml
                path: application.yml

---
apiVersion: v1
kind: Service
metadata:
  name: skywalking-oap
  namespace: middleware
  labels:
    app: skywalking-oap
spec:
  type: ClusterIP
  ports:
  # http端口，webUI使用
  - port: 12800
    name: rest
  # grpc端口，用于tracing或者metric
  - port: 11800
    name: grpc
  selector:
    app: skywalking-oap

---
# UI部署

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skywalking-ui
  namespace: middleware
  labels:
    app: skywalking-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skywalking-ui
  template:
    metadata:
      labels:
        app: skywalking-ui
    spec:
      containers:
      - name: skywalking-ui
        image: apache/skywalking-ui:8.5.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: web
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 2Gi
        env:
        - name: SW_OAP_ADDRESS
          value: skywalking-oap:12800


---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: skywalking-ui
  name: skywalking-ui
  namespace: middleware
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: web
      protocol: TCP
      name: ui-web
  selector:
    app: skywalking-ui

---
# 创建一个中间件，将自动添加ContentType的功能关闭（注意，该中间件如果要使用请手动添加到IngressRoute定义中）
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: autodetect
  namespace: middleware
spec:
  contentType:
    autoDetect: false

---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: skywalking-ui
  namespace: middleware
spec:
  entryPoints:
    - web
  routes:
  - match: Host(`skywalking-ui.kube.com`)
    kind: Rule
    services:
    - name: skywalking-ui
      port: 80
    # 中间件
    middlewares:
    - name: autodetect
